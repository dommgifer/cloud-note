<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="d0Z-5j8rYXq6HZysZPF92jj7L6L7OyH58HCB89evyr0">















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="此專案為集群及服務，可將VM和Container作為集群，對於集群內的資源可以管理，規模可彈性伸縮、成員間負載均衡、被管對象和策略可定制等等。Auto scaling的部分也由senlin管理，透過簡單的yaml定義，不需寫得像heat模板般複雜，目前Auto scaling 可以使用 senlin 或 Heat 來實現。">
<meta name="keywords" content="OpenStack">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenStack Senlin">
<meta property="og:url" content="https://dommgifer0604.herokuapp.com/2019/06/03/senlin/index.html">
<meta property="og:site_name" content="JaiWei Cloud Note">
<meta property="og:description" content="此專案為集群及服務，可將VM和Container作為集群，對於集群內的資源可以管理，規模可彈性伸縮、成員間負載均衡、被管對象和策略可定制等等。Auto scaling的部分也由senlin管理，透過簡單的yaml定義，不需寫得像heat模板般複雜，目前Auto scaling 可以使用 senlin 或 Heat 來實現。">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2019-06-04T06:18:03.483Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenStack Senlin">
<meta name="twitter:description" content="此專案為集群及服務，可將VM和Container作為集群，對於集群內的資源可以管理，規模可彈性伸縮、成員間負載均衡、被管對象和策略可定制等等。Auto scaling的部分也由senlin管理，透過簡單的yaml定義，不需寫得像heat模板般複雜，目前Auto scaling 可以使用 senlin 或 Heat 來實現。">





  
  
  <link rel="canonical" href="https://dommgifer0604.herokuapp.com/2019/06/03/senlin/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>OpenStack Senlin | JaiWei Cloud Note</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JaiWei Cloud Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首頁</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>關於</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>標籤<span class="badge">1</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>歸檔<span class="badge">5</span></a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dommgifer0604.herokuapp.com/2019/06/03/senlin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JiaWei Xie">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JaiWei Cloud Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenStack Senlin

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-03 17:31:53" itemprop="dateCreated datePublished" datetime="2019-06-03T17:31:53+08:00">2019-06-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-04 14:18:03" itemprop="dateModified" datetime="2019-06-04T14:18:03+08:00">2019-06-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">評論數：</span>
                <a href="/2019/06/03/senlin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/03/senlin/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          
            <div class="post-description">此專案為集群及服務，可將VM和Container作為集群，對於集群內的資源可以管理，規模可彈性伸縮、成員間負載均衡、被管對象和策略可定制等等。Auto scaling的部分也由senlin管理，透過簡單的yaml定義，不需寫得像heat模板般複雜，目前Auto scaling 可以使用 senlin 或 Heat 來實現。</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>使用 Auto scaling 前，請先安裝 ceilometer、gnocchi、aodh 專案，以下範例為 Queens 版。</p>
<h1 id="安裝步驟"><a href="# 安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟 </h1><p> 以下步驟在 Controller 執行。<br>確認 openstack sdk 版本是否為 0.17.2，若不是可以用 pip 安裝</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># pip show openstacksdk</span><br><span class="line">---</span><br><span class="line">Metadata-Version: 2.1</span><br><span class="line">Name: openstacksdk</span><br><span class="line">Version: 0.17.2</span><br><span class="line"></span><br><span class="line"># pip install openstacksdk==0.17.2</span><br></pre></td></tr></table></figure>

<p>安裝 senlin 請至 pypi 查看版號</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install senlin==6.0.0</span><br></pre></td></tr></table></figure>

<p>建立資料夾及 user </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># groupadd -r senlin</span><br><span class="line"># adduser --system selin senlin</span><br><span class="line"># mkdir /etc/senlin /var/log/senlin</span><br></pre></td></tr></table></figure>

<p>建立資料庫 (注意 database 的 user)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#mysql -u root -p</span><br><span class="line"></span><br><span class="line">CREATE DATABASE senlin;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON senlin.* TO &apos;admin&apos;@&apos;localhost&apos; \ </span><br><span class="line">IDENTIFIED BY &apos;openstack&apos;;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON senlin.* TO &apos;admin&apos;@&apos;%&apos; \</span><br><span class="line"> IDENTIFIED BY &apos;openstack&apos;;</span><br></pre></td></tr></table></figure>

<p>建立資料表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># senlin-manage db_sync</span><br></pre></td></tr></table></figure>

<p>設定 /etc/senlin/senlin.conf，根據環境替換 IP 和 hostname</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT]</span><br><span class="line">log_dir = /var/log/senlin</span><br><span class="line">transport_url = rabbit://openstack:openstack@controller1</span><br><span class="line"></span><br><span class="line">[senlin_api]</span><br><span class="line">bind_host = 10.50.2.4</span><br><span class="line">bind_port = 8780</span><br><span class="line"></span><br><span class="line">[receiver]</span><br><span class="line">host = 10.50.2.4</span><br><span class="line">port = 8780</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://senlin:openstack@10.50.2.3/senlin</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://10.50.2.3:5000/v3</span><br><span class="line">auth_url = http://10.50.2.3:5000</span><br><span class="line">auth_type = password</span><br><span class="line">project_name = service</span><br><span class="line">username = senlin</span><br><span class="line">password = openstack</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">memcached_servers = controller1:11211</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[authentication]</span><br><span class="line">auth_url = http://10.50.2.3:5000/v3</span><br><span class="line">service_username = senlin</span><br><span class="line">service_password = openstack</span><br><span class="line">service_project_name = service</span><br><span class="line">service_user_domain = Default</span><br><span class="line">service_project_domain = Default</span><br><span class="line"></span><br><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br><span class="line">transport_url = rabbit://openstack:openstack@10.50.2.14</span><br><span class="line"></span><br><span class="line">[oslo_policy]</span><br><span class="line">policy_file = /etc/senlin/policy.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立 user 和 Endpoint，根據環境替換 IP 和 hostname</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># openstack user create --domain default --password-prompt senlin</span><br><span class="line"># openstack role add --project service --user senlin admin</span><br><span class="line"># openstack service create --name senlin--description &quot;Senlin Clustering Service V1&quot;</span><br><span class="line"># openstack endpoint create --region RegionOne clustering public http://ip:8780</span><br><span class="line"># openstack endpoint create --region RegionOne clustering internal http://ip:8780</span><br><span class="line"># openstack endpoint create --region RegionOne clustering admin http://ip:8780</span><br></pre></td></tr></table></figure>

<p>建立 senlin-api service </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># vim /lib/systemd/system/senlin-api.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description = OpenStack Clustering Service API</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart = /usr/local/bin/senlin-api --config-file /etc/senlin/senlin.conf --log-file /var/log/senlin/senlin-api.log</span><br><span class="line">User = senlin</span><br><span class="line">TimeoutStartSec=120</span><br><span class="line">TimeoutStopSec=300</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=2</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy = multi-user.target</span><br></pre></td></tr></table></figure>

<p>建立 senlin-engine 服務 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># vim /lib/systemd/system/senlin-engine.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description = OpenStack Clustering engine Service API</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart = /usr/local/bin/senlin-engine --config-file /etc/senlin/senlin.conf --log-file /var/log/senlin/senlin-engine.log</span><br><span class="line">User = senlin</span><br><span class="line">TimeoutStartSec=120</span><br><span class="line">TimeoutStopSec=300</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=2</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy = multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立 /etc/senlin/policy.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/senlin/policy.yaml</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#&quot;context_is_admin&quot;: &quot;role:admin&quot;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#&quot;deny_everybody&quot;: &quot;!&quot;</span><br><span class="line"></span><br><span class="line"># Show build information</span><br><span class="line"># GET  /v1/build-info</span><br><span class="line">#&quot;build_info:build_info&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List profile types</span><br><span class="line"># GET  /v1/profile-types</span><br><span class="line">#&quot;profile_types:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show profile type details</span><br><span class="line"># GET  /v1/profile-types/&#123;profile_type&#125;</span><br><span class="line">#&quot;profile_types:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List profile type operations</span><br><span class="line"># GET  /v1/profile-types/&#123;profile_type&#125;/ops</span><br><span class="line">#&quot;profile_types:ops&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List policy types</span><br><span class="line"># GET  /v1/policy-types</span><br><span class="line">#&quot;policy_types:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show policy type details</span><br><span class="line"># GET  /v1/policy-types/&#123;policy_type&#125;</span><br><span class="line">#&quot;policy_types:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List clusters</span><br><span class="line"># GET  /v1/clusters</span><br><span class="line">#&quot;clusters:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Create cluster</span><br><span class="line"># POST  /v1/clusters</span><br><span class="line">#&quot;clusters:create&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Delete cluster</span><br><span class="line"># DELETE  /v1/clusters/&#123;cluster_id&#125;</span><br><span class="line">#&quot;clusters:delete&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show cluster details</span><br><span class="line"># GET  /v1/clusters/&#123;cluster_id&#125;</span><br><span class="line">#&quot;clusters:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Perform specified action on a cluster.</span><br><span class="line"># POST  /v1/clusters/&#123;cluster_id&#125;/actions</span><br><span class="line">#&quot;clusters:action&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update cluster</span><br><span class="line"># PATCH  /v1/clusters/&#123;cluster_id&#125;</span><br><span class="line">#&quot;clusters:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Collect Attributes Across a Cluster</span><br><span class="line"># GET  v1/clusters/&#123;cluster_id&#125;/attrs/&#123;path&#125;</span><br><span class="line">#&quot;clusters:collect&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Perform an Operation on a Cluster</span><br><span class="line"># POST  /v1/clusters/&#123;cluster_id&#125;/ops</span><br><span class="line">#&quot;clusters:operation&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List profiles</span><br><span class="line"># GET  /v1/profiles</span><br><span class="line">#&quot;profiles:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Create profile</span><br><span class="line"># POST  /v1/profiles</span><br><span class="line">#&quot;profiles:create&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show profile details</span><br><span class="line"># GET  /v1/profiles/&#123;profile_id&#125;</span><br><span class="line">#&quot;profiles:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Delete profile</span><br><span class="line"># DELETE  /v1/profiles/&#123;profile_id&#125;</span><br><span class="line">#&quot;profiles:delete&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update profile</span><br><span class="line"># PATCH  /v1/profiles/&#123;profile_id&#125;</span><br><span class="line">#&quot;profiles:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Validate profile</span><br><span class="line"># POST  /v1/profiles/validate</span><br><span class="line">#&quot;profiles:validate&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List nodes</span><br><span class="line"># GET  /v1/nodes</span><br><span class="line">#&quot;nodes:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Create node</span><br><span class="line"># GET  /v1/nodes</span><br><span class="line">#&quot;nodes:create&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Adopt node</span><br><span class="line"># POST  /v1/nodes/adopt</span><br><span class="line">#&quot;nodes:adopt&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Adopt node (preview)</span><br><span class="line"># POST  /v1/nodes/adopt-preview</span><br><span class="line">#&quot;nodes:adopt_preview&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show node details</span><br><span class="line"># GET  /v1/nodes/&#123;node_id&#125;</span><br><span class="line">#&quot;nodes:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Perform specified action on a Node.</span><br><span class="line"># POST  /v1/nodes/&#123;node_id&#125;/actions</span><br><span class="line">#&quot;nodes:action&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update node</span><br><span class="line"># PATCH  /v1/nodes/&#123;node_id&#125;</span><br><span class="line">#&quot;nodes:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Delete node</span><br><span class="line"># DELETE  /v1/nodes/&#123;node_id&#125;</span><br><span class="line">#&quot;nodes:delete&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Perform an Operation on a Node</span><br><span class="line"># POST  /v1/nodes/&#123;node_id&#125;/ops</span><br><span class="line">#&quot;nodes:operation&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List policies</span><br><span class="line"># GET  /v1/policies</span><br><span class="line">#&quot;policies:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Create policy</span><br><span class="line"># POST  /v1/policies</span><br><span class="line">#&quot;policies:create&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show policy details</span><br><span class="line"># GET  /v1/policies/&#123;policy_id&#125;</span><br><span class="line">#&quot;policies:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update policy</span><br><span class="line"># PATCH  /v1/policies/&#123;policy_id&#125;</span><br><span class="line">#&quot;policies:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Delete policy</span><br><span class="line"># DELETE  /v1/policies/&#123;policy_id&#125;</span><br><span class="line">#&quot;policies:delete&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Validate policy.</span><br><span class="line"># POST  /v1/policies/validate</span><br><span class="line">#&quot;policies:validate&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List cluster policies</span><br><span class="line"># GET  /v1/clusters/&#123;cluster_id&#125;/policies</span><br><span class="line">#&quot;cluster_policies:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Attach a Policy to a Cluster</span><br><span class="line"># POST  /v1/clusters/&#123;cluster_id&#125;/actions</span><br><span class="line">#&quot;cluster_policies:attach&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Detach a Policy from a Cluster</span><br><span class="line"># POST  /v1/clusters/&#123;cluster_id&#125;/actions</span><br><span class="line">#&quot;cluster_policies:detach&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update a Policy on a Cluster</span><br><span class="line"># POST  /v1/clusters/&#123;cluster_id&#125;/actions</span><br><span class="line">#&quot;cluster_policies:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show cluster_policy details</span><br><span class="line"># GET  /v1/clusters/&#123;cluster_id&#125;/policies/&#123;policy_id&#125;</span><br><span class="line">#&quot;cluster_policies:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List receivers</span><br><span class="line"># GET  /v1/receivers</span><br><span class="line">#&quot;receivers:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Create receiver</span><br><span class="line"># POST  /v1/receivers</span><br><span class="line">#&quot;receivers:create&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show receiver details</span><br><span class="line"># GET  /v1/receivers/&#123;receiver_id&#125;</span><br><span class="line">#&quot;receivers:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update receiver</span><br><span class="line"># PATCH  /v1/receivers/&#123;receiver_id&#125;</span><br><span class="line">#&quot;receivers:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Delete receiver</span><br><span class="line"># DELETE  /v1/receivers/&#123;receiver_id&#125;</span><br><span class="line">#&quot;receivers:delete&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Notify receiver</span><br><span class="line"># POST  /v1/receivers/&#123;receiver_id&#125;/notify</span><br><span class="line">#&quot;receivers:notify&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List actions</span><br><span class="line"># GET  /v1/actions</span><br><span class="line">#&quot;actions:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show action details</span><br><span class="line"># GET  /v1/actions/&#123;action_id&#125;</span><br><span class="line">#&quot;actions:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Update action</span><br><span class="line"># PATCH  /v1/actions/&#123;action_id&#125;</span><br><span class="line">#&quot;actions:update&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List events</span><br><span class="line"># GET  /v1/events</span><br><span class="line">#&quot;events:index&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Show event details</span><br><span class="line"># GET  /v1/events/&#123;event_id&#125;</span><br><span class="line">#&quot;events:get&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># Trigger webhook action</span><br><span class="line"># POST  /v1/webhooks/&#123;webhook_id&#125;/trigger</span><br><span class="line">#&quot;webhooks:trigger&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># List services</span><br><span class="line"># GET  /v1/services</span><br><span class="line">#&quot;services:index&quot;: &quot;role:admin&quot;</span><br></pre></td></tr></table></figure>

<p>修改資料夾權限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -R senlin:senlin /etc/senlin /var/log/senlin</span><br></pre></td></tr></table></figure>

<p>啟用服務 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable senlin-api </span><br><span class="line"># systemctl enable senlin-engine</span><br></pre></td></tr></table></figure>

<p>啟動服務 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart senlin-api </span><br><span class="line"># systemctl restart senlin-engine</span><br></pre></td></tr></table></figure>

<p>#Senlin dashboard<br>安裝 senlin-dashboard</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># git clone https://github.com/openstack/senlin-dashboard.git -b stable/queens</span><br><span class="line"># cd senlin-dashboard</span><br><span class="line"># pip install .</span><br></pre></td></tr></table></figure>

<p>啟用 dashboard</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cp /opt/senlin-dashboard/senlin_dashboard/enabled/_50_senlin.py /usr/share/openstack-dashboard/openstack_dashboard/local/enabled/_50_senlin.py</span><br></pre></td></tr></table></figure>

<h1 id="Auto-Scaling- 前置設定"><a href="#Auto-Scaling- 前置設定" class="headerlink" title="Auto Scaling 前置設定"></a>Auto Scaling 前置設定</h1><ul>
<li>請先安裝 ceilometer，gnocchi，aodh</li>
<li>senlin 和 gnocchi、整合有些 bug，因此需要修改一下程式碼</li>
<li>Heat 的 autoscaling 是透過 vm 中 metadata 的 server_group=stack_id 來辨識是否為同一個 heat stack，gnocchi 所儲存的資源有包含 server_group。</li>
<li>senlin 所產生的 cluster 會有 cluster_id，並且在 VM 的 metadata 加上 clusetr_id 加以辨認，但是 gnocchi 的資源並沒有 clusetr_id，因此需要手動增加。</li>
<li>修改 /usr/lib/python2.7/dist-packages/ceilometer/gnocchi_client.py，在 server_group<br>的下一行增加 cluster_id resource type <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">resources_initial = &#123;</span><br><span class="line">        &quot;instance&quot;: &#123;</span><br><span class="line">            &quot;server_group&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;min_length&quot;: 0, &quot;max_length&quot;: 255,</span><br><span class="line">                         &quot;required&quot;: False&#125;,</span><br><span class="line">            &quot;cluster_id&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;min_length&quot;: 0, &quot;max_length&quot;: 255,</span><br><span class="line">                         &quot;required&quot;: False&#125;,</span><br><span class="line">         &#125;,</span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">resources_update_operations = [</span><br><span class="line">    &#123;&quot;desc&quot;: &quot;add cluster_id to instance&quot;,</span><br><span class="line">     &quot;type&quot;: &quot;update_attribute_type&quot;,</span><br><span class="line">     &quot;resource_type&quot;: &quot;instance&quot;,</span><br><span class="line">     &quot;data&quot;: [&#123;</span><br><span class="line">         &quot;op&quot;: &quot;add&quot;,</span><br><span class="line">         &quot;path&quot;: &quot;/attributes/cluster_id&quot;,</span><br><span class="line">         &quot;value&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;min_length&quot;: 0, &quot;max_length&quot;: 255,</span><br><span class="line">                   &quot;required&quot;: False&#125;</span><br><span class="line">     &#125;]&#125;,</span><br><span class="line">               </span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>修改 /usr/lib/python2.7/dist-packages/ceilometer/publisher/data/gnocchi_resources.yaml，<br> 在 server_group: 下一行加入 cluster_id </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- resource_type: instance</span><br><span class="line">  attributes:</span><br><span class="line">     server_group: resource_metadata.user_metadata.server_group</span><br><span class="line">     cluster_id: resource_metadata.user_metadata.cluster_id   </span><br></pre></td></tr></table></figure>

<p>刪除已編譯的 gnocchi_client.pyc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rm /usr/lib/python2.7/dist-packages/ceilometer/gnocchi_client.pyc</span><br></pre></td></tr></table></figure>

<p>更新 ceilometer 和 gnocchi 資料庫</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi-upgrade</span><br><span class="line"># ceilometer-upgrade</span><br></pre></td></tr></table></figure>

<p>如果不想修改程式碼 可以使用 gnocchi api 更新 resource </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PATCH /v1/resource_type/my_custom_type HTTP/1.1</span><br><span class="line">Content-Type: application/json-patch+json</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">    &quot;op&quot;: &quot;add&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/attributes/cluster_id&quot;,</span><br><span class="line">    &quot;value&quot;: &#123;</span><br><span class="line">    	&quot;type&quot;: &quot;string&quot;,</span><br><span class="line">    	&quot;min_length&quot;: 0, </span><br><span class="line">    	&quot;max_length&quot;: 255, </span><br><span class="line">    	&quot;required&quot;: false</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>在 /etc/ceilometer/ceilometer.conf 增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">reserved_metadata_keys = cluster_id</span><br></pre></td></tr></table></figure>

<p>重啟 ceilometer 服務 (controller)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-notification restart</span><br><span class="line"># service ceilometer-agent-central restart</span><br></pre></td></tr></table></figure>

<p>重啟 ceilometer-agent-compute (compute)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-compute restart</span><br></pre></td></tr></table></figure>

<p>再來修改 aodh，senlin 的 VM scaling 是透過呼叫 webhook 的方式增加減少 VM，但是呼叫 webhook 時，不能送出有值的 body，而 aodh alarm 所觸發的 webhook 一定會送出含有資料的 body，之後 senlin 增加了功能，如果呼叫 scaling 的 webhook，要送出有值的 body ，必須要加入 header openstack-api-version = clustering 1.10，但是 aodh 的 alarm 所送出的 header 只有 content-type = application/json，因此需要修改程式碼。</p>
<p>修改 /usr/lib/python2.7/dist-packages/aodh/notifier/rest.py，在 headers[‘content-type’]下一行增加 header ‘openstack-api-version’ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">headers[&apos;content-type&apos;] = &apos;application/json&apos;</span><br><span class="line">headers[&apos;openstack-api-version&apos;] = &apos;clustering 1.10&apos;</span><br></pre></td></tr></table></figure>

<p>刪除已編譯的 rest.pyc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rm /usr/lib/python2.7/dist-packages/aodh/notifier/rest.pyc</span><br></pre></td></tr></table></figure>

<p>重啟 aodh 服務</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># service apache2 restart</span><br><span class="line"># service aodh-evaluator restart</span><br><span class="line"># service aodh-notifier restart</span><br><span class="line"># service aodh-listener restart</span><br></pre></td></tr></table></figure>

<p>檢查是否成功新增 gnocchi instance 的 resource type 裡的 cluster_id 屬性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># openstack metric resource-type show instance</span><br><span class="line">+-------------------------+-----------------------------------------------------------+</span><br><span class="line">| Field                   | Value                                                     |</span><br><span class="line">+-------------------------+-----------------------------------------------------------+</span><br><span class="line">| attributes/cluster_id   | max_length=255, min_length=0, required=False, type=string |</span><br><span class="line">| attributes/created_at   | required=False, type=datetime                             |</span><br><span class="line">| attributes/deleted_at   | required=False, type=datetime                             |</span><br><span class="line">| attributes/display_name | max_length=255, min_length=0, required=True, type=string  |</span><br><span class="line">| attributes/flavor_id    | max_length=255, min_length=0, required=True, type=string  |</span><br><span class="line">| attributes/flavor_name  | max_length=255, min_length=0, required=True, type=string  |</span><br><span class="line">| attributes/host         | max_length=255, min_length=0, required=True, type=string  |</span><br><span class="line">| attributes/image_ref    | max_length=255, min_length=0, required=False, type=string |</span><br><span class="line">| attributes/launched_at  | required=False, type=datetime                             |</span><br><span class="line">| attributes/server_group | max_length=255, min_length=0, required=False, type=string |</span><br><span class="line">| name                    | instance                                                  |</span><br><span class="line">| state                   | active                                                    |</span><br><span class="line">+-------------------------+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h1 id="使用 -Auto-Scaling"><a href="# 使用 -Auto-Scaling" class="headerlink" title="使用 Auto Scaling"></a>使用 Auto Scaling</h1><p>建立 VM 模板，此模板為 scaling 的 VM，建立 server.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type: os.nova.server</span><br><span class="line">version: 1.0</span><br><span class="line">properties:</span><br><span class="line">  name: cirros_server</span><br><span class="line">  flavor: m1.tiny</span><br><span class="line">  image: cirros-0.3.5-x86_64-disk</span><br><span class="line">  key_name: oskey</span><br><span class="line">  networks:</span><br><span class="line">    - network: private</span><br></pre></td></tr></table></figure>

<p>建立 profile ，也就是樣板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># openstack cluster profile create --spec-file server.yaml pserver</span><br><span class="line"></span><br><span class="line">+------------+----------------------------------------------+</span><br><span class="line">| Field      | Value                                        |</span><br><span class="line">+------------+----------------------------------------------+</span><br><span class="line">| created_at | 2019-02-19T07:08:10Z                         |</span><br><span class="line">| domain_id  | None                                         |</span><br><span class="line">| id         | 3a3ad404-5676-4f9d-b424-a74b25abce88         |</span><br><span class="line">| location   | None                                         |</span><br><span class="line">| metadata   | &#123;&#125;                                           |</span><br><span class="line">| name       | pserver                                      |</span><br><span class="line">| project_id | e214ad5b451a4616a4689afb58e7dbc8             |</span><br><span class="line">| spec       | +------------+-----------------------------+ |</span><br><span class="line">|            | | property   | value                       | |</span><br><span class="line">|            | +------------+-----------------------------+ |</span><br><span class="line">|            | | properties | &#123;                           | |</span><br><span class="line">|            | |            |   &quot;key_name&quot;: &quot;mykey&quot;,      | |</span><br><span class="line">|            | |            |   &quot;flavor&quot;: &quot;m1.tiny&quot;,      | |</span><br><span class="line">|            | |            |   &quot;networks&quot;: [| |</span><br><span class="line">|            | |            |     &#123;                       | |</span><br><span class="line">|            | |            |       &quot;network&quot;: &quot;demo-net&quot; | |</span><br><span class="line">|            | |            |     &#125;                       | |</span><br><span class="line">|            | |            |   ],                        | |</span><br><span class="line">|            | |            |   &quot;image&quot;: &quot;cirros&quot;,        | |</span><br><span class="line">|            | |            |   &quot;name&quot;: &quot;cirros_server&quot;   | |</span><br><span class="line">|            | |            | &#125;                           | |</span><br><span class="line">|            | | type       | os.nova.server              | |</span><br><span class="line">|            | | version    | 1.0                         | |</span><br><span class="line">|            | +------------+-----------------------------+ |</span><br><span class="line">| type       | os.nova.server-1.0                           |</span><br><span class="line">| updated_at | None                                         |</span><br><span class="line">| user_id    | e26bd520e7044d78b8966c7f3ce9b364             |</span><br><span class="line">+------------+----------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立 cluster，–desired-capacity 指定 cluster node 起始數量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># openstack cluster create --profile pserver --desired-capacity 1 --min-size 1 mycluster</span><br><span class="line"></span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| Field            | Value                                |</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| config           | &#123;&#125;                                   |</span><br><span class="line">| created_at       | None                                 |</span><br><span class="line">| data             | &#123;&#125;                                   |</span><br><span class="line">| dependents       | &#123;&#125;                                   |</span><br><span class="line">| desired_capacity | 1                                    |</span><br><span class="line">| domain_id        | None                                 |</span><br><span class="line">| id               | 2682c9e0-0231-4506-8a69-a95bb764bcea |</span><br><span class="line">| init_at          | 2019-02-19T07:30:29Z                 |</span><br><span class="line">| location         | None                                 |</span><br><span class="line">| max_size         | -1                                   |</span><br><span class="line">| metadata         | &#123;&#125;                                   |</span><br><span class="line">| min_size         | 0                                    |</span><br><span class="line">| name             | mycluster                            |</span><br><span class="line">| node_ids         |                                      |</span><br><span class="line">| profile_id       | 3a3ad404-5676-4f9d-b424-a74b25abce88 |</span><br><span class="line">| profile_name     | pserver                              |</span><br><span class="line">| project_id       | e214ad5b451a4616a4689afb58e7dbc8     |</span><br><span class="line">| status           | INIT                                 |</span><br><span class="line">| status_reason    | Initializing                         |</span><br><span class="line">| timeout          | 3600                                 |</span><br><span class="line">| updated_at       | None                                 |</span><br><span class="line">| user_id          | e26bd520e7044d78b8966c7f3ce9b364     |</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看 cluster 資訊</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># openstack cluster show mycluster</span><br><span class="line"></span><br><span class="line">+------------------+--------------------------------------------------------------------------------+</span><br><span class="line">| Field            | Value                                                                          |</span><br><span class="line">+------------------+--------------------------------------------------------------------------------+</span><br><span class="line">| config           | &#123;&#125;                                                                             |</span><br><span class="line">| created_at       | 2019-02-19T07:31:00Z                                                           |</span><br><span class="line">| data             | &#123;&#125;                                                                             |</span><br><span class="line">| dependents       | &#123;&#125;                                                                             |</span><br><span class="line">| desired_capacity | 1                                                                              |</span><br><span class="line">| domain_id        | None                                                                           |</span><br><span class="line">| id               | 2682c9e0-0231-4506-8a69-a95bb764bcea                                           |</span><br><span class="line">| init_at          | 2019-02-19T07:30:29Z                                                           |</span><br><span class="line">| location         | None                                                                           |</span><br><span class="line">| max_size         | -1                                                                             |</span><br><span class="line">| metadata         | &#123;&#125;                                                                             |</span><br><span class="line">| min_size         | 0                                                                              |</span><br><span class="line">| name             | mycluster                                                                      |</span><br><span class="line">| node_ids         | 27aab314-9d4a-4a3f-9545-788ec12bd5f9                                           |</span><br><span class="line">| profile_id       | 3a3ad404-5676-4f9d-b424-a74b25abce88                                           |</span><br><span class="line">| profile_name     | pserver                                                                        |</span><br><span class="line">| project_id       | e214ad5b451a4616a4689afb58e7dbc8                                               |</span><br><span class="line">| status           | ACTIVE                                                                         |</span><br><span class="line">| status_reason    | CLUSTER_CREATE: number of active nodes is equal or above desired_capacity (1). |</span><br><span class="line">| timeout          | 3600                                                                           |</span><br><span class="line">| updated_at       | 2019-02-19T07:31:00Z                                                           |</span><br><span class="line">| user_id          | e26bd520e7044d78b8966c7f3ce9b364                                               |</span><br><span class="line">+------------------+--------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>將上述所得到的 cluster id 匯入環境變數</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># export MYCLUSTER_ID=2682c9e0-0231-4506-8a69-a95bb764bcea</span><br></pre></td></tr></table></figure>

<p>建立 Receiver webhook，透過觸發 webhook，可以執行所設定的 action，Receiver 可以設定的 action 如下:</p>
<ul>
<li>CLUSTER_SCALE_OUT</li>
<li>CLUSTER_SCALE_IN</li>
<li>CLUSTER_RESIZE</li>
<li>CLUSTER_CHECK</li>
<li>CLUSTER_UPDATE</li>
<li>CLUSTER_DELETE</li>
<li>CLUSTER_ADD_NODES</li>
<li>CLUSTER_DEL_NODES</li>
<li>NODE_CREATE</li>
<li>NODE_DELETE</li>
<li>NODE_UPDATE</li>
<li>NODE_CHECK</li>
<li>NODE_RECOVER</li>
</ul>
<p>Auto scaling 需要 scale_out 和 sacle_in ，因此建立兩個 Receiver，count 是指觸發一次後要增加減少的 node 數量 <br> 建立 Receiver CLUSTER_SCALE_OUT </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># openstack cluster receiver create --action CLUSTER_SCALE_OUT --params count=1 --cluster mycluster scale_out</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field      | Value                                                                                                       |</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| action     | CLUSTER_SCALE_OUT                                                                                           |</span><br><span class="line">| actor      | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;trust_id&quot;: &quot;1795bf3ee52a44f6bcf681144f15c4c3&quot;                                                            |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| channel    | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;alarm_url&quot;: &quot;http://10.50.2.4:8780/v1/webhooks/706eab3c-6269-409f-9675-abf14523de31/trigger?V=1&amp;count=1&quot; |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| cluster_id | 2682c9e0-0231-4506-8a69-a95bb764bcea                                                                        |</span><br><span class="line">| created_at | 2019-02-19T07:40:22Z                                                                                        |</span><br><span class="line">| domain_id  | None                                                                                                        |</span><br><span class="line">| id         | 706eab3c-6269-409f-9675-abf14523de31                                                                        |</span><br><span class="line">| location   | None                                                                                                        |</span><br><span class="line">| name       | scale_out                                                                                                   |</span><br><span class="line">| params     | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;count&quot;: &quot;1&quot;                                                                                              |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| project_id | e214ad5b451a4616a4689afb58e7dbc8                                                                            |</span><br><span class="line">| type       | webhook                                                                                                     |</span><br><span class="line">| updated_at | None                                                                                                        |</span><br><span class="line">| user_id    | e26bd520e7044d78b8966c7f3ce9b364                                                                            |</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立 Receiver CLUSTER_SCALE_IN </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># openstack cluster receiver create --action CLUSTER_SCALE_IN --params count=1 --cluster mycluster scale_in</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field      | Value                                                                                                       |</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| action     | CLUSTER_SCALE_IN                                                                                            |</span><br><span class="line">| actor      | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;trust_id&quot;: &quot;1795bf3ee52a44f6bcf681144f15c4c3&quot;                                                            |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| channel    | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;alarm_url&quot;: &quot;http://10.50.2.5:8780/v1/webhooks/e8079cfd-2e21-4630-93f0-5dfed1c55299/trigger?V=1&amp;count=1&quot; |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| cluster_id | 2682c9e0-0231-4506-8a69-a95bb764bcea                                                                        |</span><br><span class="line">| created_at | 2019-02-19T07:40:56Z                                                                                        |</span><br><span class="line">| domain_id  | None                                                                                                        |</span><br><span class="line">| id         | e8079cfd-2e21-4630-93f0-5dfed1c55299                                                                        |</span><br><span class="line">| location   | None                                                                                                        |</span><br><span class="line">| name       | scale_in                                                                                                    |</span><br><span class="line">| params     | &#123;                                                                                                           |</span><br><span class="line">|            |   &quot;count&quot;: &quot;1&quot;                                                                                              |</span><br><span class="line">|            | &#125;                                                                                                           |</span><br><span class="line">| project_id | e214ad5b451a4616a4689afb58e7dbc8                                                                            |</span><br><span class="line">| type       | webhook                                                                                                     |</span><br><span class="line">| updated_at | None                                                                                                        |</span><br><span class="line">| user_id    | e26bd520e7044d78b8966c7f3ce9b364                                                                            |</span><br><span class="line">+------------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>匯入環境變數 alarm_url，此 URL 為 webhook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># export ALRM_URLOUT=&quot;http://10.50.2.4:8780/v1/webhooks/706eab3c-6269-409f-9675-abf14523de31/trigger?V=1&amp;count=1&quot;</span><br><span class="line"># export ALRM_URLIN=&quot;http://10.50.2.5:8780/v1/webhooks/e8079cfd-2e21-4630-93f0-5dfed1c55299/trigger?V=1&amp;count=1&quot;</span><br></pre></td></tr></table></figure>

<p>建立 aodh alarm，以下為參數設定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* metric: 根據什麼發出 alarm，這裡選擇 cpu 使用率，cpu_util</span><br><span class="line">* alarm-action: alarm 時要觸發的 webhook，為上述的 alarm_url</span><br><span class="line">* query: query 出 VM 的 metadata 中相同 cluster_id 的 VM，並聚合所有的 metric，請填入 cluster_id</span><br><span class="line">* threshold: 閥值，當監測的量此值，會觸發 1 次 alarm，這裡設定 cpu 70%</span><br><span class="line">* comparison-operator: 跟 threshold 結合，gt 就是大於，lt 小於，範例 gt 就是大於 70</span><br><span class="line">* evaluation-periods: 週期，到達幾次定的 threshold，就會發出 alarm，此範例為到達 1 次 cpu 大於 70%，就發出 alarm</span><br><span class="line">* aggregation-method: 如何計算 query 出的 metric 值，這裡填入平均 mean，</span><br><span class="line">* repeat-actions: 重複執行 alarm-action，當 alarm 持續發生時，是否重複觸發 alarm-action</span><br></pre></td></tr></table></figure>

<p>建立 cpu-high 警示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># aodh alarm create \</span><br><span class="line">--type gnocchi_aggregation_by_resources_threshold \</span><br><span class="line">--name cpu-high \</span><br><span class="line">--metric cpu_util \</span><br><span class="line">--threshold 70 \</span><br><span class="line">--comparison-operator gt \</span><br><span class="line">--description &apos;instance running hot&apos; \</span><br><span class="line">--evaluation-periods 1 \</span><br><span class="line">--aggregation-method mean \</span><br><span class="line">--alarm-action $ALRM_URLOUT \</span><br><span class="line">--granularity 60 \</span><br><span class="line">--repeat-actions True \</span><br><span class="line">--query &apos;&#123;&quot;=&quot;: &#123;&quot;cluster_id&quot;: &quot;2682c9e0-0231-4506-8a69-a95bb764bcea&quot;&#125;&#125;&apos; \</span><br><span class="line">--resource-type instance</span><br><span class="line"></span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field                     | Value                                                                                           |</span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br><span class="line">| aggregation_method        | mean                                                                                            |</span><br><span class="line">| alarm_actions             | [u&apos;http://10.50.2.4:8780/v1/webhooks/706eab3c-6269-409f-9675-abf14523de31/trigger?V=1&amp;count=1&apos;] |</span><br><span class="line">| alarm_id                  | c541927c-2611-48a3-8e45-3bdcd4ccb533                                                            |</span><br><span class="line">| comparison_operator       | gt                                                                                              |</span><br><span class="line">| description               | instance running hot                                                                            |</span><br><span class="line">| enabled                   | True                                                                                            |</span><br><span class="line">| evaluation_periods        | 1                                                                                               |</span><br><span class="line">| granularity               | 60                                                                                              |</span><br><span class="line">| insufficient_data_actions | []                                                                                              |</span><br><span class="line">| metric                    | cpu_util                                                                                        |</span><br><span class="line">| name                      | cpu-high                                                                                        |</span><br><span class="line">| ok_actions                | []                                                                                              |</span><br><span class="line">| project_id                | e214ad5b451a4616a4689afb58e7dbc8                                                                |</span><br><span class="line">| query                     | &#123;&quot;=&quot;: &#123;&quot;cluster_id&quot;: &quot;2682c9e0-0231-4506-8a69-a95bb764bcea&quot;&#125;&#125;                                   |</span><br><span class="line">| repeat_actions            | True                                                                                            |</span><br><span class="line">| resource_type             | instance                                                                                        |</span><br><span class="line">| severity                  | low                                                                                             |</span><br><span class="line">| state                     | insufficient data                                                                               |</span><br><span class="line">| state_reason              | Not evaluated yet                                                                               |</span><br><span class="line">| state_timestamp           | 2019-02-19T10:02:16.086730                                                                      |</span><br><span class="line">| threshold                 | 70.0                                                                                            |</span><br><span class="line">| time_constraints          | []                                                                                              |</span><br><span class="line">| timestamp                 | 2019-02-19T10:02:16.086730                                                                      |</span><br><span class="line">| type                      | gnocchi_aggregation_by_resources_threshold                                                      |</span><br><span class="line">| user_id                   | e26bd520e7044d78b8966c7f3ce9b364                                                                |</span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立 cpu-low 警示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># aodh alarm create \</span><br><span class="line">--type gnocchi_aggregation_by_resources_threshold \</span><br><span class="line">--name cpu-low \</span><br><span class="line">--metric cpu_util \</span><br><span class="line">--threshold 30 \</span><br><span class="line">--comparison-operator lt \</span><br><span class="line">--description &apos;instance running cold&apos; \</span><br><span class="line">--evaluation-periods 1 \</span><br><span class="line">--aggregation-method mean \</span><br><span class="line">--alarm-action $ALRM_URLIN \</span><br><span class="line">--granularity 60 \</span><br><span class="line">--repeat-actions True \</span><br><span class="line">--query &apos;&#123;&quot;=&quot;: &#123;&quot;cluster_id&quot;: &quot;2682c9e0-0231-4506-8a69-a95bb764bcea&quot;&#125;&#125;&apos; \</span><br><span class="line">--resource-type instance</span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field                     | Value                                                                                           |</span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br><span class="line">| aggregation_method        | mean                                                                                            |</span><br><span class="line">| alarm_actions             | [u&apos;http://10.50.2.5:8780/v1/webhooks/e8079cfd-2e21-4630-93f0-5dfed1c55299/trigger?V=1&amp;count=1&apos;] |</span><br><span class="line">| alarm_id                  | 7b0e8f10-251c-42db-be40-f46a1e276faa                                                            |</span><br><span class="line">| comparison_operator       | lt                                                                                              |</span><br><span class="line">| description               | instance running cold                                                                           |</span><br><span class="line">| enabled                   | True                                                                                            |</span><br><span class="line">| evaluation_periods        | 1                                                                                               |</span><br><span class="line">| granularity               | 60                                                                                              |</span><br><span class="line">| insufficient_data_actions | []                                                                                              |</span><br><span class="line">| metric                    | cpu_util                                                                                        |</span><br><span class="line">| name                      | cpu-low                                                                                         |</span><br><span class="line">| ok_actions                | []                                                                                              |</span><br><span class="line">| project_id                | e214ad5b451a4616a4689afb58e7dbc8                                                                |</span><br><span class="line">| query                     | &#123;&quot;=&quot;: &#123;&quot;cluster_id&quot;: &quot;2682c9e0-0231-4506-8a69-a95bb764bcea&quot;&#125;&#125;                                   |</span><br><span class="line">| repeat_actions            | True                                                                                            |</span><br><span class="line">| resource_type             | instance                                                                                        |</span><br><span class="line">| severity                  | low                                                                                             |</span><br><span class="line">| state                     | insufficient data                                                                               |</span><br><span class="line">| state_reason              | Not evaluated yet                                                                               |</span><br><span class="line">| state_timestamp           | 2019-02-20T02:50:17.389596                                                                      |</span><br><span class="line">| threshold                 | 30.0                                                                                            |</span><br><span class="line">| time_constraints          | []                                                                                              |</span><br><span class="line">| timestamp                 | 2019-02-20T02:50:17.389596                                                                      |</span><br><span class="line">| type                      | gnocchi_aggregation_by_resources_threshold                                                      |</span><br><span class="line">| user_id                   | e26bd520e7044d78b8966c7f3ce9b364                                                                |</span><br><span class="line">+---------------------------+-------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>進入 VM，對 VM 做 CPU 壓力測試，此為 cirros 範例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat /dev/zero &gt; /dev/bull</span><br></pre></td></tr></table></figure>

<p>使用 openstack alarm 查看警示狀態</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># watch openstack alarm list</span><br><span class="line">+--------------------------------------+--------------------------------------------+----------+-------+----------+---------+</span><br><span class="line">| alarm_id                             | type                                       | name     | state | severity | enabled |</span><br><span class="line">+--------------------------------------+--------------------------------------------+----------+-------+----------+---------+</span><br><span class="line">| 7b0e8f10-251c-42db-be40-f46a1e276faa | gnocchi_aggregation_by_resources_threshold | cpu-low  | ok    | low      | True    |</span><br><span class="line">| c541927c-2611-48a3-8e45-3bdcd4ccb533 | gnocchi_aggregation_by_resources_threshold | cpu-high | alarm | low      | True    |</span><br><span class="line">+--------------------------------------+--------------------------------------------+----------+-------+----------+---------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 openstack cluster 查看集群是否有擴展</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># watch openstack cluster show </span><br><span class="line">+------------------+------------------------------------------+</span><br><span class="line">| Field            | Value                                    |</span><br><span class="line">+------------------+------------------------------------------+</span><br><span class="line">| config           | &#123;&#125;                                       |</span><br><span class="line">| created_at       | 2019-02-19T07:31:00Z                     |</span><br><span class="line">| data             | &#123;&#125;                                       |</span><br><span class="line">| dependents       | &#123;&#125;                                       |</span><br><span class="line">| desired_capacity | 4                                        |</span><br><span class="line">| domain_id        | None                                     |</span><br><span class="line">| id               | 2682c9e0-0231-4506-8a69-a95bb764bcea     |</span><br><span class="line">| init_at          | 2019-02-19T07:30:29Z                     |</span><br><span class="line">| location         | None                                     |</span><br><span class="line">| max_size         | -1                                       |</span><br><span class="line">| metadata         | &#123;&#125;                                       |</span><br><span class="line">| min_size         | 0                                        |</span><br><span class="line">| name             | mycluster                                |</span><br><span class="line">| node_ids         | 2e23692b-388c-4fd6-b159-8398bf1a5688     |</span><br><span class="line">|                  | 3fc73090-80d5-4e31-b3fc-15901c1d1cd1     |</span><br><span class="line">|                  | c2ef243d-697c-476b-b74a-cdbb61f5c4b2     |</span><br><span class="line">|                  | eb959317-5dc8-466f-a054-aaf75134875f     |</span><br><span class="line">| profile_id       | 3a3ad404-5676-4f9d-b424-a74b25abce88     |</span><br><span class="line">| profile_name     | pserver                                  |</span><br><span class="line">| project_id       | e214ad5b451a4616a4689afb58e7dbc8         |</span><br><span class="line">| status           | RESIZING                                 |</span><br><span class="line">| status_reason    | Node node-Zb9FrKHm: Creation in progress |</span><br><span class="line">| timeout          | 3600                                     |</span><br><span class="line">| updated_at       | 2019-02-20T03:07:01Z                     |</span><br><span class="line">| user_id          | e26bd520e7044d78b8966c7f3ce9b364         |</span><br><span class="line">+------------------+------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OpenStack/" rel="tag"># OpenStack</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/03/grafana-integration-gnocchi/" rel="next" title="Grafana Integration Gnocchi">
                <i class="fa fa-chevron-left"></i> Grafana Integration Gnocchi
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/04/octavia/" rel="prev" title="OpenStack Octavia">
                OpenStack Octavia <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">JiaWei Xie</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/dommgifer" title="GitHub &rarr; https://github.com/dommgifer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:dommgifer@gmail.com" title="E-Mail &rarr; mailto:dommgifer@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安裝步驟"><span class="nav-number">1.</span> <span class="nav-text">安裝步驟 </span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Auto-Scaling- 前置設定"><span class="nav-number">2.</span> <span class="nav-text">Auto Scaling 前置設定</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用 -Auto-Scaling"><span class="nav-number">3.</span> <span class="nav-text">使用 Auto Scaling</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JiaWei Xie</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 強力驅動 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://dommgifer.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://dommgifer0604.herokuapp.com/2019/06/03/senlin/";
    this.page.identifier = "2019/06/03/senlin/";
    this.page.title = 'OpenStack Senlin';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://dommgifer.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
