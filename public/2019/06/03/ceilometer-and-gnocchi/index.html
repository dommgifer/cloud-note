<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="此篇說明如何安裝 ceilometer  和 gnocchi 注意事項在安裝過程發現 Queens 版官方的套件有問題，導致在安裝 gnocchi-api 時會有python2 和 python3 套件衝突，導致刪除 cinder-api、 keystone、libapache2-mod-wsgi、 nova-placement-api、 openstack-dashboard，因此需要加入新的">
<meta name="keywords" content="OpenStack">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceilometer and Gnocchi Install">
<meta property="og:url" content="https://jiawei0604.herokuapp.com/2019/06/03/ceilometer-and-gnocchi/index.html">
<meta property="og:site_name" content="JaiWei Cloud Note">
<meta property="og:description" content="此篇說明如何安裝 ceilometer  和 gnocchi 注意事項在安裝過程發現 Queens 版官方的套件有問題，導致在安裝 gnocchi-api 時會有python2 和 python3 套件衝突，導致刪除 cinder-api、 keystone、libapache2-mod-wsgi、 nova-placement-api、 openstack-dashboard，因此需要加入新的">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2019-06-03T03:45:02.735Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ceilometer and Gnocchi Install">
<meta name="twitter:description" content="此篇說明如何安裝 ceilometer  和 gnocchi 注意事項在安裝過程發現 Queens 版官方的套件有問題，導致在安裝 gnocchi-api 時會有python2 和 python3 套件衝突，導致刪除 cinder-api、 keystone、libapache2-mod-wsgi、 nova-placement-api、 openstack-dashboard，因此需要加入新的">





  
  
  <link rel="canonical" href="https://jiawei0604.herokuapp.com/2019/06/03/ceilometer-and-gnocchi/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ceilometer and Gnocchi Install | JaiWei Cloud Note</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JaiWei Cloud Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首頁</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>關於</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>標籤<span class="badge">1</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>歸檔<span class="badge">2</span></a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jiawei0604.herokuapp.com/2019/06/03/ceilometer-and-gnocchi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JiaWei Xie">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JaiWei Cloud Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ceilometer and Gnocchi Install

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-03 11:45:02" itemprop="dateCreated datePublished" datetime="2019-06-03T11:45:02+08:00">2019-06-03</time>
            

            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>此篇說明如何安裝 ceilometer  和 gnocchi</p>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>在安裝過程發現 Queens 版官方的套件有問題，導致在安裝 gnocchi-api 時會有python2 和 python3 套件衝突，導致刪除 cinder-api、 keystone、libapache2-mod-wsgi、 nova-placement-api、 openstack-dashboard，因此需要加入新的 repository</p>
<a id="more"></a>
<p>Ubuntu 16.04版本要安裝 gnocchi-api 需要加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-apt-repository cloud-archive:queens-proposed</span><br></pre></td></tr></table></figure>

<p>官方 BUG: : <a href="https://bugs.launchpad.net/ubuntu/+source/gnocchi/+bug/1746992" target="_blank" rel="noopener">https://bugs.launchpad.net/ubuntu/+source/gnocchi/+bug/1746992</a></p>
<h2 id="建立資料庫"><a href="#建立資料庫" class="headerlink" title="建立資料庫"></a>建立資料庫</h2><p>請注意你的使用者和密碼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># mysql -u root -p</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE gnocchi;</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON gnocchi.* TO &apos;gnocchi&apos;@&apos;localhost&apos; \</span><br><span class="line">  IDENTIFIED BY &apos;GNOCCHI_DBPASS&apos;;</span><br><span class="line">  </span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON gnocchi.* TO &apos;gnocchi&apos;@&apos;%&apos; \</span><br><span class="line">  IDENTIFIED BY &apos;GNOCCHI_DBPASS&apos;;</span><br></pre></td></tr></table></figure>

<h2 id="建立服務"><a href="#建立服務" class="headerlink" title="建立服務"></a>建立服務</h2><p>建立 OpenStack gnocchi 和 ceilometer 使用者及服務</p>
<p>請將  $ALL_HOST 改為 controller IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># openstack user create --domain default --password-prompt ceilometer</span><br><span class="line"># openstack user create --domain default --password-prompt gnocchi</span><br><span class="line"></span><br><span class="line"># openstack role add --project service --user ceilometer admin</span><br><span class="line"># openstack role add --project service --user gnocchi admin</span><br><span class="line"></span><br><span class="line"># openstack service create --name gnocchi --description &quot;Metric Service&quot; metric</span><br><span class="line"></span><br><span class="line"># openstack endpoint create --region RegionOne metric public http://$ALL_HOST:8041</span><br><span class="line"># openstack endpoint create --region RegionOne metric internal http://$ALL_HOST:8041</span><br><span class="line"># openstack endpoint create --region RegionOne metric admin http://$ALL_HOST:8041</span><br></pre></td></tr></table></figure>

<h2 id="修改-gnocchi-conf"><a href="#修改-gnocchi-conf" class="headerlink" title="修改 gnocchi.conf"></a>修改 gnocchi.conf</h2><p>修改 /etc/gnocchi/gnocchi.conf</p>
<p>根據你的環境，修改下面參數</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack@192.168.1.10</span><br><span class="line"></span><br><span class="line">[api]</span><br><span class="line">auth_mode = keystone</span><br><span class="line">middlewares = oslo_middleware.cors.CORS</span><br><span class="line">middlewares = keystonemiddleware.auth_token.AuthProtocol</span><br><span class="line">auth_mode = keystone</span><br><span class="line"></span><br><span class="line">[indexer]</span><br><span class="line">url = mysql+pymysql://openstack:openstack@192.168.1.10/gnocchi</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">auth_host = http://192.168.1.10:5000/v3/</span><br><span class="line">auth_protocol = http</span><br><span class="line">admin_user = admin</span><br><span class="line">admin_password = openstack</span><br><span class="line">admin_tenant_name = admin</span><br><span class="line">auth_url = http://192.168.1.10:5000/v3</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = gnocchi</span><br><span class="line">password = openstack</span><br><span class="line">interface = internalURL</span><br><span class="line">region_name = RegionOne</span><br><span class="line"></span><br><span class="line">[storage]</span><br><span class="line">coordination_url = file:///var/lib/gnocchi/locks</span><br><span class="line">file_basepath = /var/lib/gnocchi</span><br><span class="line">driver = file</span><br></pre></td></tr></table></figure>

<h2 id="新增-gnocchi-api-conf"><a href="#新增-gnocchi-api-conf" class="headerlink" title="新增 gnocchi-api.conf"></a>新增 gnocchi-api.conf</h2><p>新增 /etc/apache2/sites-available/gnocchi-api.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Listen 8041</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8041&gt;</span><br><span class="line">    WSGIDaemonProcess gnocchi processes=2 threads=10 user=gnocchi display-name=%&#123;GROUP&#125;</span><br><span class="line">    WSGIProcessGroup gnocchi</span><br><span class="line">    WSGIScriptAlias / /usr/bin/gnocchi-api</span><br><span class="line">    WSGIApplicationGroup %&#123;GLOBAL&#125;</span><br><span class="line">    &lt;IfVersion &gt;= 2.4&gt;</span><br><span class="line">        ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;</span><br><span class="line">    &lt;/IfVersion&gt;</span><br><span class="line">    ErrorLog /var/log/apache2/gnocchi_error.log</span><br><span class="line">    CustomLog /var/log/apache2/gnocchi_access.log combined</span><br><span class="line">    &lt;Directory /&gt;</span><br><span class="line">        &lt;IfVersion &gt;= 2.4&gt;</span><br><span class="line">            Require all granted</span><br><span class="line">        &lt;/IfVersion&gt;</span><br><span class="line">        &lt;IfVersion &lt; 2.4&gt;</span><br><span class="line">            Order allow,deny</span><br><span class="line">            Allow from all</span><br><span class="line">        &lt;/IfVersion&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h2 id="建立-gnocchi-資料表"><a href="#建立-gnocchi-資料表" class="headerlink" title="建立 gnocchi 資料表"></a>建立 gnocchi 資料表</h2><p>使用 gnocchi-upgrade 建立資料表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi-upgrade</span><br></pre></td></tr></table></figure>

<h2 id="重啟-gnocchi-服務"><a href="#重啟-gnocchi-服務" class="headerlink" title="重啟 gnocchi 服務"></a>重啟 gnocchi 服務</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># service apache2 restart</span><br><span class="line"># service gnocchi-metricd restart</span><br></pre></td></tr></table></figure>

<h2 id="修改-var-lib-gnocchi-權限"><a href="#修改-var-lib-gnocchi-權限" class="headerlink" title="修改 /var/lib/gnocchi 權限"></a>修改 /var/lib/gnocchi 權限</h2><p>請將 /var/lib/gnocchi 權限設為 gnocchi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -R gnocchi:gnocchi /var/lib/gnocchi</span><br></pre></td></tr></table></figure>

<h2 id="修改-admin-openrc"><a href="#修改-admin-openrc" class="headerlink" title="修改 admin-openrc"></a>修改 admin-openrc</h2><p>如果要使用 gnocchi 的指令，需要將 admin-openrc 加入以下參數，才能使用指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OS_AUTH_TYPE=password</span><br></pre></td></tr></table></figure>

<h2 id="安裝-ceilometer"><a href="#安裝-ceilometer" class="headerlink" title="安裝 ceilometer"></a>安裝 ceilometer</h2><h3 id="Controller-節點"><a href="#Controller-節點" class="headerlink" title="Controller 節點"></a>Controller 節點</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># apt install -y ceilometer-agent-notification ceilometer-agent-central</span><br></pre></td></tr></table></figure>

<h4 id="修改-ceilometer-conf"><a href="#修改-ceilometer-conf" class="headerlink" title="修改 ceilometer.conf"></a>修改 ceilometer.conf</h4><p>跟據環境，修改以下參數</p>
<p>修改 /etc/ceilometer/ceilometer.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack@192.168.1.10</span><br><span class="line"></span><br><span class="line">[dispatcher_gnocchi]</span><br><span class="line">filter_service_activity = False</span><br><span class="line">archive_policy = high</span><br><span class="line"></span><br><span class="line">[service_credentials]</span><br><span class="line">auth_url = http://10.50.2.10:5000/v3</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_id = default</span><br><span class="line">user_domain_id = default</span><br><span class="line">project_name = service</span><br><span class="line">username = ceilometer</span><br><span class="line">password = openstack</span><br><span class="line">interface = internalURL</span><br><span class="line">region_name = RegionOne</span><br></pre></td></tr></table></figure>

<h4 id="建立-ceilometer-resource"><a href="#建立-ceilometer-resource" class="headerlink" title="建立 ceilometer resource"></a>建立 ceilometer resource</h4><p>在 gnocchi 裡建立 ceilometer 的 resource</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ceilometer-upgrade</span><br></pre></td></tr></table></figure>

<h4 id="重啟-ceilometer-服務"><a href="#重啟-ceilometer-服務" class="headerlink" title="重啟 ceilometer 服務"></a>重啟 ceilometer 服務</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-central restart</span><br><span class="line"># service ceilometer-agent-notification restart</span><br></pre></td></tr></table></figure>

<h4 id="修改-glance-api-conf-和-glance-registry-conf"><a href="#修改-glance-api-conf-和-glance-registry-conf" class="headerlink" title="修改 glance-api.conf 和 glance-registry.conf"></a>修改 glance-api.conf 和 glance-registry.conf</h4><p>修改 /etc/glance/glance-api.conf 和 /etc/glance/glance-registry.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack@192.168.1.10</span><br><span class="line"></span><br><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br></pre></td></tr></table></figure>

<h4 id="修改-neutron-conf"><a href="#修改-neutron-conf" class="headerlink" title="修改 neutron.conf"></a>修改 neutron.conf</h4><p>修改 /etc/neutron/neutron.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br></pre></td></tr></table></figure>

<h4 id="修改-cinder-conf"><a href="#修改-cinder-conf" class="headerlink" title="修改 cinder.conf"></a>修改 cinder.conf</h4><p>修改 /etc/cinder/cinder.conf (volume節點上的也需要修改)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br></pre></td></tr></table></figure>

<h4 id="修改-heat-conf"><a href="#修改-heat-conf" class="headerlink" title="修改 heat.conf"></a>修改 heat.conf</h4><p>修改 /etc/heat/heat.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br></pre></td></tr></table></figure>

<h4 id="重啟上述服務"><a href="#重啟上述服務" class="headerlink" title="重啟上述服務"></a>重啟上述服務</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># service glance-registry restart</span><br><span class="line"># service glance-api restart</span><br><span class="line"></span><br><span class="line"># service neutron-server restart</span><br><span class="line"></span><br><span class="line"># service apache2 restart</span><br><span class="line"># service cinder-api restart</span><br><span class="line"># service cinder-scheduler restart</span><br><span class="line"># service cinder-volume restart</span><br><span class="line"></span><br><span class="line"># service heat-api restart</span><br><span class="line"># service heat-api-cfn restart</span><br><span class="line"># service heat-engine restart</span><br></pre></td></tr></table></figure>

<h3 id="Compute-節點"><a href="#Compute-節點" class="headerlink" title="Compute 節點"></a>Compute 節點</h3><p>安裝 ceilometer-agent-compute</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># apt-get install ceilometer-agent-compute</span><br></pre></td></tr></table></figure>

<h4 id="修改-ceilometer-conf-1"><a href="#修改-ceilometer-conf-1" class="headerlink" title="修改 ceilometer.conf"></a>修改 ceilometer.conf</h4><p>根據環境，修改以下參數</p>
<p>修改 /etc/ceilometer/ceilometer.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:openstack@192.168.1.10</span><br><span class="line">[service_credentials]</span><br><span class="line">auth_url = http://10.50.2.10:5000/v3</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_id = default</span><br><span class="line">user_domain_id = default</span><br><span class="line">project_name = service</span><br><span class="line">username = ceilometer</span><br><span class="line">password = openstack</span><br><span class="line">interface = internalURL</span><br><span class="line">region_name = RegionOne</span><br></pre></td></tr></table></figure>

<h4 id="修改-nova-conf"><a href="#修改-nova-conf" class="headerlink" title="修改 nova.conf"></a>修改 nova.conf</h4><p>修改 /etc/nova/nova.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">instance_usage_audit = True</span><br><span class="line">instance_usage_audit_period = hour</span><br><span class="line">notify_on_state_change = vm_and_task_state</span><br><span class="line"></span><br><span class="line">[oslo_messaging_notifications]</span><br><span class="line">driver = messagingv2</span><br></pre></td></tr></table></figure>

<h4 id="重啟服務"><a href="#重啟服務" class="headerlink" title="重啟服務"></a>重啟服務</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-compute restart</span><br><span class="line"># service nova-compute restart</span><br></pre></td></tr></table></figure>

<h2 id="修改-polling-yaml"><a href="#修改-polling-yaml" class="headerlink" title="修改 polling.yaml"></a>修改 polling.yaml</h2><p>為了監測 VM 的 disk，增加下列至 /etc/ceilometer/polling.yaml 的 some_pollsters</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- disk.usage</span><br><span class="line">- disk.device.usage</span><br><span class="line">- disk.device.read.bytes</span><br><span class="line">- disk.device.read.requests</span><br><span class="line">- disk.device.write.bytes</span><br><span class="line">- disk.device.write.requests</span><br></pre></td></tr></table></figure>

<h2 id="其他事項"><a href="#其他事項" class="headerlink" title="其他事項"></a>其他事項</h2><p>監測的間隔預設為5分鐘，政策為 low，可以使用 gnocchi 查看其他監測的政策，預設有三種: low, medium , high ，granularity 為間隔時間，也可以建立自己的政策，目前尚未嘗試。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi archive-policy list</span><br><span class="line">+--------+-------------+-----------------------------------------------------------------------+---------------------------------+</span><br><span class="line">| name   | back_window | definition                                                            | aggregation_methods             |</span><br><span class="line">+--------+-------------+-----------------------------------------------------------------------+---------------------------------+</span><br><span class="line">| bool   |        3600 | - points: 31536000, granularity: 0:00:01, timespan: 365 days, 0:00:00 | last                            |</span><br><span class="line">| high   |           0 | - points: 3600, granularity: 0:00:01, timespan: 1:00:00               | std, count, min, max, sum, mean |</span><br><span class="line">|        |             | - points: 10080, granularity: 0:01:00, timespan: 7 days, 0:00:00      |                                 |</span><br><span class="line">|        |             | - points: 8760, granularity: 1:00:00, timespan: 365 days, 0:00:00     |                                 |</span><br><span class="line">| low    |           0 | - points: 8640, granularity: 0:05:00, timespan: 30 days, 0:00:00      | std, count, min, max, sum, mean |</span><br><span class="line">| medium |           0 | - points: 10080, granularity: 0:01:00, timespan: 7 days, 0:00:00      | std, count, min, max, sum, mean |</span><br><span class="line">|        |             | - points: 8760, granularity: 1:00:00, timespan: 365 days, 0:00:00     |                                 |</span><br><span class="line">+--------+-------------+-----------------------------------------------------------------------+---------------------------------+</span><br></pre></td></tr></table></figure>

<p>若要修改間隔，請修改 ceilometer.conf 的 [dispatcher_gnocchi]，以及/etc/ceilometer/polling.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[dispatcher_gnocchi]</span><br><span class="line">archive_policy = high</span><br></pre></td></tr></table></figure>

<p>polling.yaml (interval原為300，compute上的也要修改)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sources:</span><br><span class="line">    - name: some_pollsters</span><br><span class="line">      interval: 60</span><br></pre></td></tr></table></figure>

<p>conteroller 重啟服務</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-central restart</span><br><span class="line"># service ceilometer-agent-notification restart</span><br></pre></td></tr></table></figure>

<p>compute 重啟服務</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service ceilometer-agent-compute restart</span><br></pre></td></tr></table></figure>

<p>透過 gnocchi 的指令，可以取得 VM 的監控值，用 resource show –type instance VM_UUID， 可以得到此 VM 的各資源監測的 ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi resource show --type instance 7e157c6a-7b2a-4893-8819-bfc033e37f39</span><br><span class="line">+-----------------------+---------------------------------------------------------------------+</span><br><span class="line">| Field                 | Value                                                               |</span><br><span class="line">+-----------------------+---------------------------------------------------------------------+</span><br><span class="line">| created_by_project_id | 6b53bd8ecb01408d8d76a48ae3878723                                    |</span><br><span class="line">| created_by_user_id    | 3942272c165f4c258663ed130e8171e2                                    |</span><br><span class="line">| creator               | 3942272c165f4c258663ed130e8171e2:6b53bd8ecb01408d8d76a48ae3878723   |</span><br><span class="line">| display_name          | test                                                                |</span><br><span class="line">| ended_at              | None                                                                |</span><br><span class="line">| flavor_id             | 2                                                                   |</span><br><span class="line">| flavor_name           | m1.small                                                            |</span><br><span class="line">| host                  | compute1                                                            |</span><br><span class="line">| id                    | 7e157c6a-7b2a-4893-8819-bfc033e37f39                                |</span><br><span class="line">| image_ref             | None                                                                |</span><br><span class="line">| metrics               | compute.instance.booting.time: 53c30c1e-1c84-4946-8171-b15afe0ddfbd |</span><br><span class="line">|                       | cpu.delta: 732c0318-195c-4735-a0db-0866cfb88189                     |</span><br><span class="line">|                       | cpu: 2a273f20-917c-46f4-95b7-934c57ebd148                           |</span><br><span class="line">|                       | cpu_l3_cache: f032f4e9-8947-4096-9fcd-222e93b255ef                  |</span><br><span class="line">|                       | cpu_util: 4a0d8c08-56b1-47f7-8dc9-3fa8d56c53df                      |</span><br><span class="line">|                       | disk.allocation: 063b2800-e26e-45ae-8840-8d53976743b1               |</span><br><span class="line">|                       | disk.capacity: df6d2a85-19ec-4a69-8409-b2d56222635e                 |</span><br><span class="line">|                       | disk.ephemeral.size: c04d6e90-dca6-454c-8be8-29d2ca765b89           |</span><br><span class="line">|                       | disk.iops: cc8605a9-6687-42fd-af92-1372ae9692dc                     |</span><br><span class="line">|                       | disk.latency: 6d1205a6-8e6b-45ce-a4b5-a48f62b26880                  |</span><br><span class="line">|                       | disk.read.bytes.rate: d9f5dbc8-24c5-40e5-88f4-0b9c36bfd197          |</span><br><span class="line">|                       | disk.read.bytes: 8ff22fe3-c91a-41de-b7f6-06ce77098b79               |</span><br><span class="line">|                       | disk.read.requests.rate: 7b820453-7455-40f2-8808-7437651fc351       |</span><br><span class="line">|                       | disk.read.requests: 60e98d20-36b0-4fe8-adf3-86e827be15d4            |</span><br><span class="line">|                       | disk.root.size: 8da968ca-9703-4625-b7c3-8f13460dae77                |</span><br><span class="line">|                       | disk.usage: 8046e635-bfa6-45e5-bc28-a8ce8aefeefa                    |</span><br><span class="line">|                       | disk.write.bytes.rate: b186f91d-f61c-40a3-8577-a0e443b92f7a         |</span><br><span class="line">|                       | disk.write.bytes: 9c414ba1-597e-4bda-a154-c0131af03505              |</span><br><span class="line">|                       | disk.write.requests.rate: 235445a2-d278-4a55-955b-ab1e6a5c567a      |</span><br><span class="line">|                       | disk.write.requests: 8cf3b36b-c4f0-4b30-bcce-9463b89e2e3a           |</span><br><span class="line">|                       | memory.bandwidth.local: 054870ba-06e6-473f-a37b-e7efcf9188e9        |</span><br><span class="line">|                       | memory.bandwidth.total: ee244a7a-1532-40db-8fb1-96bfcfdee2d9        |</span><br><span class="line">|                       | memory.resident: a045ff95-c7e5-4162-9345-ac68a2993981               |</span><br><span class="line">|                       | memory.swap.in: 6162d2f2-6f6c-4fab-99e5-b4fbb9a8844e                |</span><br><span class="line">|                       | memory.swap.out: a6d9846c-ffd9-471f-8175-4c900af55c99               |</span><br><span class="line">|                       | memory.usage: 8b8706a2-d108-445c-8a22-c8dcab2d4950                  |</span><br><span class="line">|                       | memory: 3d2e70c8-7fd2-4557-b30c-3090749c5014                        |</span><br><span class="line">|                       | perf.cache.misses: dae14570-1c80-472b-9bb2-9818921d03cd             |</span><br><span class="line">|                       | perf.cache.references: 0a294dea-decf-4707-8b4d-9ef92ffc2e87         |</span><br><span class="line">|                       | perf.cpu.cycles: be19335c-9873-4c9d-9011-0e4ef9931ab4               |</span><br><span class="line">|                       | perf.instructions: d5d99bcc-044f-4543-a27f-7526a35826b9             |</span><br><span class="line">|                       | vcpus: 6e2b7fd0-3fbd-4481-843f-cd705408cb05                         |</span><br><span class="line">| original_resource_id  | 7e157c6a-7b2a-4893-8819-bfc033e37f39                                |</span><br><span class="line">| project_id            | 885c63821c3a43a78da157958eca3a99                                    |</span><br><span class="line">| revision_end          | None                                                                |</span><br><span class="line">| revision_start        | 2018-05-03T06:51:06.014722+00:00                                    |</span><br><span class="line">| server_group          | None                                                                |</span><br><span class="line">| started_at            | 2018-05-03T06:51:06.014643+00:00                                    |</span><br><span class="line">| type                  | instance                                                            |</span><br><span class="line">| user_id               | be23e663a2ef4873bbbfee411b421049                                    |</span><br><span class="line">+-----------------------+---------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>再透過 gnocchi measures show METRICS_ID，查詢上面的 metrics 的監測值，例如要查詢上述 VM 的 cpu_util (CPU 使用率)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi measures show 4a0d8c08-56b1-47f7-8dc9-3fa8d56c53df</span><br><span class="line">+---------------------------+-------------+-----------------+</span><br><span class="line">| timestamp                 | granularity |           value |</span><br><span class="line">+---------------------------+-------------+-----------------+</span><br><span class="line">| 2018-05-03T13:24:00+00:00 |        60.0 |  0.149982089639 |</span><br><span class="line">| 2018-05-03T13:25:00+00:00 |        60.0 |  0.166708385488 |</span><br><span class="line">| 2018-05-03T13:26:00+00:00 |        60.0 |   0.14998932576 |</span><br><span class="line">| 2018-05-03T13:27:00+00:00 |        60.0 |  0.149992996335 |</span><br><span class="line">| 2018-05-03T13:28:00+00:00 |        60.0 |  0.133337124552 |</span><br><span class="line">| 2018-05-03T13:29:00+00:00 |        60.0 |  0.166712370593 |</span><br><span class="line">| 2018-05-03T13:30:00+00:00 |        60.0 |  0.150029974686 |</span><br><span class="line">+---------------------------+-------------+-----------------+</span><br></pre></td></tr></table></figure>

<p>若要取得 VM 網路的監測值，使用 gnocchi resource list –type instance_network_interface， 取得 ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi resource list --type instance_network_interface | grep 7e157c6a-7b2a-4893-8819-bfc033e37f39</span><br><span class="line">+--------------------------------------+----------------------------+----------------------------------+----------------------------------+-----------------------------------------------------------------------+----------------------------------+----------------------------------+----------------------------------+--------------+--------------------------------------+-------------------------------------------------------------------+----------------+</span><br><span class="line">| id                                   | type                       | project_id                       | user_id                          | original_resource_id                                                  | started_at                       | ended_at                         | revision_start                   | revision_end | instance_id                          | creator                                                           | name           |</span><br><span class="line">+--------------------------------------+----------------------------+----------------------------------+----------------------------------+-----------------------------------------------------------------------+----------------------------------+----------------------------------+----------------------------------+--------------+--------------------------------------+-------------------------------------------------------------------+----------------+</span><br><span class="line"></span><br><span class="line">| 06d1109b-fc23-5369-947d-564aff231fc4 | instance_network_interface | 885c63821c3a43a78da157958eca3a99 | be23e663a2ef4873bbbfee411b421049 | instance-00000011-7e157c6a-7b2a-4893-8819-bfc033e37f39-tap594786b7-d9 | 2018-05-03T06:51:55.592433+00:00 | None                             | 2018-05-03T06:51:55.592459+00:00 | None         | 7e157c6a-7b2a-4893-8819-bfc033e37f39 | 3942272c165f4c258663ed130e8171e2:6b53bd8ecb01408d8d76a48ae3878723 | tap594786b7-d9 |</span><br></pre></td></tr></table></figure>

<p>再使用 gnocchi resource show 取得監測資源 ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi resource show --type instance_network_interface 06d1109b-fc23-5369-947d-564aff231fc4</span><br><span class="line">+-----------------------+-----------------------------------------------------------------------+</span><br><span class="line">| Field                 | Value                                                                 |</span><br><span class="line">+-----------------------+-----------------------------------------------------------------------+</span><br><span class="line">| created_by_project_id | 6b53bd8ecb01408d8d76a48ae3878723                                      |</span><br><span class="line">| created_by_user_id    | 3942272c165f4c258663ed130e8171e2                                      |</span><br><span class="line">| creator               | 3942272c165f4c258663ed130e8171e2:6b53bd8ecb01408d8d76a48ae3878723     |</span><br><span class="line">| ended_at              | None                                                                  |</span><br><span class="line">| id                    | 06d1109b-fc23-5369-947d-564aff231fc4                                  |</span><br><span class="line">| instance_id           | 7e157c6a-7b2a-4893-8819-bfc033e37f39                                  |</span><br><span class="line">| metrics               | network.incoming.bytes.rate: e8c3d083-0ede-4719-a88a-eca92b653fed     |</span><br><span class="line">|                       | network.incoming.bytes: 92ccff55-2ba8-452a-9ca9-b11daf7a3e8c          |</span><br><span class="line">|                       | network.incoming.packets.drop: 889d6986-dfc6-40c7-a28c-d2543616d059   |</span><br><span class="line">|                       | network.incoming.packets.error: d3dc4693-b6cd-4c15-89e5-9bf92a2bcae0  |</span><br><span class="line">|                       | network.incoming.packets.rate: c6422bd1-cf03-4cfc-8e79-edd37851ae00   |</span><br><span class="line">|                       | network.incoming.packets: fd860305-7c1c-45fe-a3ef-a5e843f24e4b        |</span><br><span class="line">|                       | network.outgoing.bytes.rate: 1431543c-91ae-4aed-b506-330f18a18805     |</span><br><span class="line">|                       | network.outgoing.bytes: 4db6ea32-9ea3-4e7c-a881-40f0ef82203d          |</span><br><span class="line">|                       | network.outgoing.packets.drop: c49c0019-5a1a-4582-8abd-d82608a111a8   |</span><br><span class="line">|                       | network.outgoing.packets.error: 7e725029-d676-4c98-b1ea-d568d2bc80b0  |</span><br><span class="line">|                       | network.outgoing.packets.rate: bc28b58f-b848-48d3-bfd6-c3995b09a50e   |</span><br><span class="line">|                       | network.outgoing.packets: f7057ae3-0080-4f6f-8fdb-04b5129b7fd0        |</span><br><span class="line">| name                  | tap594786b7-d9                                                        |</span><br><span class="line">| original_resource_id  | instance-00000011-7e157c6a-7b2a-4893-8819-bfc033e37f39-tap594786b7-d9 |</span><br><span class="line">| project_id            | 885c63821c3a43a78da157958eca3a99                                      |</span><br><span class="line">| revision_end          | None                                                                  |</span><br><span class="line">| revision_start        | 2018-05-03T06:51:55.592459+00:00                                      |</span><br><span class="line">| started_at            | 2018-05-03T06:51:55.592433+00:00                                      |</span><br><span class="line">| type                  | instance_network_interface                                            |</span><br><span class="line">| user_id               | be23e663a2ef4873bbbfee411b421049                                      |</span><br><span class="line">+-----------------------+-----------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>接下來用gnocchi measures show METRICS_ID，根據上述的 ID 取得監測值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi measures show 06d1109b-fc23-5369-947d-564aff231fc4</span><br><span class="line">+---------------------------+-------------+------------+</span><br><span class="line">| timestamp                 | granularity |    value   |</span><br><span class="line">+---------------------------+-------------+------------+</span><br><span class="line">| 2018-05-04T07:00:00+00:00 |        60.0 |   208353.0 |</span><br><span class="line">| 2018-05-04T07:01:00+00:00 |        60.0 |   209253.0 |</span><br><span class="line">| 2018-05-04T07:02:00+00:00 |        60.0 |   210153.0 |</span><br><span class="line">| 2018-05-04T07:03:00+00:00 |        60.0 |   211053.0 |</span><br><span class="line">| 2018-05-04T07:04:00+00:00 |        60.0 |   211953.0 |</span><br><span class="line">| 2018-05-04T07:05:00+00:00 |        60.0 |   212853.0 |</span><br><span class="line">| 2018-05-04T07:06:00+00:00 |        60.0 |   213753.0 |</span><br><span class="line">+---------------------------+-------------+------------+</span><br></pre></td></tr></table></figure>

<p>更快的查詢方式，根據VM ID查詢，查詢 instance 相關監測值: (resource-type 為 instance，最後面的參數為要查詢的 metrics，範例為 cpu_util)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi measures aggregation --resource-type instance --query &apos;instance_id=&quot;7e157c6a-7b2a-4893-8819-bfc033e37f39&quot;&apos; --granularity 60 --aggregation mean -m cpu_util</span><br></pre></td></tr></table></figure>

<p>查詢 instance network interface 相關監測值:(resource-type為 instance_network_interface，最後面的參數為要查詢的metrics，  範例為network.incoming.bytes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gnocchi measures aggregation --resource-type instance_network_interface  --query &apos;instance_id=&quot;7e157c6a-7b2a-4893-8819-bfc033e37f39&quot;&apos; --granularity 60 --aggregation mean -m network.incoming.bytes</span><br></pre></td></tr></table></figure>


      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OpenStack/" rel="tag"># OpenStack</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/03/aodh-install/" rel="prev" title="Aodh Install">
                Aodh Install <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">JiaWei Xie</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">標籤</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/dommgifer" title="GitHub &rarr; https://github.com/dommgifer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:dommgifer@gmail.com" title="E-Mail &rarr; mailto:dommgifer@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事項"><span class="nav-number">1.</span> <span class="nav-text">注意事項</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立資料庫"><span class="nav-number">2.</span> <span class="nav-text">建立資料庫</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立服務"><span class="nav-number">3.</span> <span class="nav-text">建立服務</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-gnocchi-conf"><span class="nav-number">4.</span> <span class="nav-text">修改 gnocchi.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新增-gnocchi-api-conf"><span class="nav-number">5.</span> <span class="nav-text">新增 gnocchi-api.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立-gnocchi-資料表"><span class="nav-number">6.</span> <span class="nav-text">建立 gnocchi 資料表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重啟-gnocchi-服務"><span class="nav-number">7.</span> <span class="nav-text">重啟 gnocchi 服務</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-var-lib-gnocchi-權限"><span class="nav-number">8.</span> <span class="nav-text">修改 /var/lib/gnocchi 權限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-admin-openrc"><span class="nav-number">9.</span> <span class="nav-text">修改 admin-openrc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安裝-ceilometer"><span class="nav-number">10.</span> <span class="nav-text">安裝 ceilometer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Controller-節點"><span class="nav-number">10.1.</span> <span class="nav-text">Controller 節點</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-ceilometer-conf"><span class="nav-number">10.1.1.</span> <span class="nav-text">修改 ceilometer.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建立-ceilometer-resource"><span class="nav-number">10.1.2.</span> <span class="nav-text">建立 ceilometer resource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重啟-ceilometer-服務"><span class="nav-number">10.1.3.</span> <span class="nav-text">重啟 ceilometer 服務</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-glance-api-conf-和-glance-registry-conf"><span class="nav-number">10.1.4.</span> <span class="nav-text">修改 glance-api.conf 和 glance-registry.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-neutron-conf"><span class="nav-number">10.1.5.</span> <span class="nav-text">修改 neutron.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-cinder-conf"><span class="nav-number">10.1.6.</span> <span class="nav-text">修改 cinder.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-heat-conf"><span class="nav-number">10.1.7.</span> <span class="nav-text">修改 heat.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重啟上述服務"><span class="nav-number">10.1.8.</span> <span class="nav-text">重啟上述服務</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compute-節點"><span class="nav-number">10.2.</span> <span class="nav-text">Compute 節點</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-ceilometer-conf-1"><span class="nav-number">10.2.1.</span> <span class="nav-text">修改 ceilometer.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-nova-conf"><span class="nav-number">10.2.2.</span> <span class="nav-text">修改 nova.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重啟服務"><span class="nav-number">10.2.3.</span> <span class="nav-text">重啟服務</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-polling-yaml"><span class="nav-number">11.</span> <span class="nav-text">修改 polling.yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他事項"><span class="nav-number">12.</span> <span class="nav-text">其他事項</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JiaWei Xie</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 強力驅動 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
